<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión</title>
    <link rel="stylesheet" href="assets/AdminLTE-3.2.0/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="assets/AdminLTE-3.2.0/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="assets/AdminLTE-3.2.0/plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <link rel="stylesheet" href="assets/styles.css">
</head>

<body class="hold-transition login-page">
    <div class="d-flex align-items-center justify-content-center vh-100 w-100">
        <div class="col col-sm-12 col-md-8 col-lg-4 col-xl-4">
            <div class="card" id="formulario_de_login">
                <div class="card-header d-flex justify-content-center align-items-center"
                    style="background-color: #777DA7; text-align: center; color: white;">
                    <div class="card-title">
                        <h1>Iniciar Sesión</h1>
                    </div>
                </div>
                <div class="card-body">
                    <form id="loginForm" class="form-group" method="post">
                        <label for="campo_usr">Usuario</label>
                        <div class="input-group mb-3">
                            <input type="text" name="usuario_o_correo" class="form-control" id="campo_usr"
                                placeholder="Usuario" maxlength="25" required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-user"></span>
                                </div>
                            </div>
                        </div>
                        <label for="password1">Contraseña</label>
                        <div class="input-group mb-3">
                            <input type="password" name="contraseña" class="form-control" placeholder="Contraseña"
                                id="password1" required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-eye" id="togglePassword1"
                                        style="cursor: pointer; margin-right: 5px;"></span>
                                    <span class="fas fa-lock"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12" style="text-align: center">
                                <button type="submit" class="btn btn-login btn-block">Iniciar Sesión</button>
                                <p id="texto_registrase" data-toggle="modal" data-target="#modal-default">
                                    <u>Registrarse</u>
                                </p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <form id="registroForm" action="backend/agregrar_usuario.php" method="post">
        <div class="modal fade" id="modal-default">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">

                    <div class="modal-header encabezado-menu-registro">
                        <h4 class="modal-title">Registrate</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">

                        <label for="name">Usuario</label>
                        <!-- Campo de Usuario -->
                        <div class="input-group mb-3">
                            <input type="text" id="name" name="name" class="form-control" placeholder="Usuario"
                                maxlength="25" required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-user"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Campo de Correo -->
                        <label for="email">Correo</label>
                        <div class="input-group mb-3">
                            <input id="email" name="email" class="form-control" placeholder="Correo" maxlength="49"
                                required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-envelope"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Campo de Contraseña -->
                        <label for="password2">Contraseña</label>
                        <div class="input-group mb-3">
                            <input type="password" name="password" class="form-control" placeholder="Contraseña"
                                id="password2" maxlength="24" required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-eye" id="togglePassword2"
                                        style="cursor: pointer; margin-right: 5px;"></span>
                                    <span class="fas fa-lock"></span>
                                </div>
                            </div>
                        </div>

                        <!--Confirmar Contra-->
                        <label for="password3">Confirmar Contraseña</label>
                        <div class="input-group mb-3">
                            <input type="password" name="password" class="form-control" placeholder="Contraseña"
                                id="password3" required>
                            <div class="input-group-append">
                                <div class="input-group-text">
                                    <span class="fas fa-eye" id="togglePassword3"
                                        style="cursor: pointer; margin-right: 5px;"></span>
                                    <span class="fas fa-lock"></span>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Contenedor de mensaje de éxito o error -->
                    <div id="mensaje" class="mensaje"></div>
                    <!--BOTON DE REGISTRO-->
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default">
                            Registrar
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </form>

    <script src="assets/AdminLTE-3.2.0/plugins/jquery/jquery.min.js"></script>
    <script src="assets/AdminLTE-3.2.0/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/AdminLTE-3.2.0/plugins/sweetalert2/sweetalert2.all.min.js"></script>

    <!--Login de usr-->
    <script>
        $(document).ready(function () {
            // Interceptar el envío del formulario de Login
            $("#loginForm").on("submit", function (e) {
                e.preventDefault(); // Evita que se recargue la página

                $.ajax({
                    type: "POST",
                    url: "backend/procesar_login.php", // Archivo PHP que procesará el login
                    data: $(this).serialize(),
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                            // Animación de éxito
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: response.message,
                                timer: 700,
                                showConfirmButton: false,
                                allowOutsideClick: false,
                                allowEscapeKey: false,
                                allowEnterKey: false
                            }).then(() => {
                                window.location.href = response.redirect;
                            });
                        } else {
                            // Animación de error
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.message
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Contraseña o usuario incorrecto'
                        });
                    }
                });
            });

        });
    </script>

    <!--Mostrar y ocultar contraseña de login-->
    <script>
        const togglePassword = document.querySelector('#togglePassword1');
        const passwordField = document.querySelector('#password1');

        togglePassword.addEventListener('click', function () {
            // Alterna el tipo de input entre 'password' y 'text'
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);

            // Cambia el ícono según el estado de la contraseña
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    </script>
    <!--Mostrar y ocultar contraseña de registro-->
    <script>
        const togglePassword2 = document.querySelector('#togglePassword2');
        const passwordField2 = document.querySelector('#password2');

        togglePassword2.addEventListener('click', function () {
            // Alterna el tipo de input entre 'password' y 'text'
            const type = passwordField2.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField2.setAttribute('type', type);

            // Cambia el ícono según el estado de la contraseña
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    </script>

    <script>
        const togglePassword3 = document.querySelector('#togglePassword3');
        const passwordField3 = document.querySelector('#password3');

        togglePassword3.addEventListener('click', function () {
            // Alterna el tipo de input entre 'password' y 'text'
            const type = passwordField3.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField3.setAttribute('type', type);

            // Cambia el ícono según el estado de la contraseña
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    </script>


    <!--Registro de usuarios-->
    <script>
        document.getElementById("registroForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Prevenir el envío del formulario automático

            const emailField = document.getElementById("email").value;
            const emailRegex = /^[a-zA-Z0-9._%+-]+@(gmail|outlook|yahoo|icloud|)\.com$/;
            const nameField = document.getElementById("name").value;
            const password1 = document.getElementById('password2').value;
            const password2 = document.getElementById('password3').value;

            //Validar que el usr tenga minimo 4 caracteres
            if (nameField.length < 4) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre de usuario debe tener al menos 4 caracteres',
                });
                return;
            }
            // Validar si el correo es válido
            if (!emailRegex.test(emailField)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El correo debe terminar con @gmail.com, @outlook.com, @yahoo.com o @icloud.com',
                });
                return;
            }
            //Validar que las contraseñas tengan al menos 6 caracteres
            if (password1.length < 6 || password2.length < 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'La contraseña debe tener al menos 6 caracteres',
                });
                return;
            }
            //Validar que las contrsenas sean iguales
            if (password1 !== password2) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Las contraseñas deben ser iguales.',
                });
                return;
            }

            // Enviar el formulario con Fetch
            const formData = new FormData(this);
            fetch(this.action, {
                method: "POST",
                body: formData
            })
                .then(response => {
                    if (response.ok) {
                        // Mostrar alerta de éxito con SweetAlert
                        Swal.fire({
                            icon: 'success',
                            title: 'Usuario registrado exitosamente',
                            showConfirmButton: false,
                            timer: 1500
                        }).then(() => {
                            // Redirigir al login o cerrar el modal
                            $('#modal-dafult').modal('hide'); // Cierra el modal
                            window.location.href = 'index.html';
                        });
                    } else {
                        throw new Error("Error al registrar usuario");
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error de conexión: ' + error.message,
                    });
                });
        });
    </script>
</body>

</html>
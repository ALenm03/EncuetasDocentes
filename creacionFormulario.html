<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Dinámico</title>
    <link rel="stylesheet" href="assets/AdminLTE-3.2.0/dist/css/adminlte.css">
    <link rel="stylesheet" href="assets/AdminLTE-3.2.0/plugins/fontawesome-free/css/all.min.css">
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body class="body">

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header nombre_del_from_bg">
                        <div class="card-title nombre_del_from text-center w-100">
                            <h1>Ingresar Nombre del Formulario</h1>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="form-group">
                            <label for="txtcaja">Ingrese el nombre del Formulario</label>
                            <input type="text" class="form-control" maxlength="60" placeholder="Nombre del formulario" id="txtcaja"> 
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header nombre_del_from_bg">
                        <div class="card-title nombre_del_from text-center w-100">
                            <h1>Preguntas</h1>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="form-group">
                            <div id="form-preguntas">  </div>

                            <button type="button" class="btn btn_anadir_pregunta" id="anadir_pregunta">Añadir Pregunta</button>
                            <button type="submit" class="btn btn_guardar_form">Guardar Formulario</button>
                            <button type="button" class="btn btn_borrar" id="borrar_pregunta">Borrar Última Pregunta</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AdminTLE JavaScript -->
    <script src="assets/AdminLTE-3.2.0/plugins/jquery/jquery.js"></script>
    <script src="assets/AdminLTE-3.2.0/plugins/bootstrap/js/bootstrap.bundle.js"></script>
    <script src="assets/AdminLTE-3.2.0/dist/js/adminlte.js"></script>

    <script>
        const formContainer = document.getElementById('form-preguntas');
    
        // Función para agregar una nueva pregunta
        document.getElementById('anadir_pregunta').addEventListener('click', function () {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('form-group', 'mb-4');
    
            // Contar cuántas preguntas existen y asignar el número de la nueva pregunta
            const numPreguntas = formContainer.querySelectorAll('.form-group').length + 1;
    
            // Crear el label para el número de la pregunta
            const questionLabel = document.createElement('label');
            questionLabel.textContent = `Pregunta número ${numPreguntas}`;
            questionLabel.classList.add('form-label', 'mb-2');
    
            // Crear el campo para ingresar la pregunta
            const questionInput = document.createElement('input');
            questionInput.setAttribute('type', 'text');
            questionInput.setAttribute('placeholder', 'Escribe la pregunta');
            questionInput.classList.add('form-control', 'mb-2', 'pregunta');
    
            // Crear el contenedor para los botones de tipo de respuesta
            const buttonGroup = document.createElement('div');
            buttonGroup.classList.add('btn-group', 'mb-2');
    
            // Variable para almacenar el tipo de respuesta seleccionado
            let tipoSeleccionado = null;
    
            // Botón para agregar respuesta tipo párrafo
            const btnParrafo = document.createElement('button');
            btnParrafo.classList.add('btn', 'btn-secondary');
            btnParrafo.textContent = 'Añadir Respuesta Párrafo';
            btnParrafo.addEventListener('click', function () {
                if (tipoSeleccionado !== 'parrafo') {
                    borrarRespuestas(questionDiv);
                    tipoSeleccionado = 'parrafo';
                    agregarRespuesta(questionDiv, 'parrafo');
                }
            });
    
            // Botón para agregar respuesta tipo checkbox
            const btnCheckbox = document.createElement('button');
            btnCheckbox.classList.add('btn', 'btn-secondary');
            btnCheckbox.textContent = 'Añadir Respuesta Checkbox';
            btnCheckbox.addEventListener('click', function () {
                if (tipoSeleccionado !== 'checkbox') {
                    borrarRespuestas(questionDiv);
                    tipoSeleccionado = 'checkbox';
                }
                const respuestas = questionDiv.querySelectorAll('.respuesta');
                if (respuestas.length < 4) {
                    agregarRespuesta(questionDiv, 'checkbox');
                }
            });
    
            // Botón para agregar respuesta tipo opción múltiple
            const btnOpcionMultiple = document.createElement('button');
            btnOpcionMultiple.classList.add('btn', 'btn-secondary');
            btnOpcionMultiple.textContent = 'Añadir Respuesta Opción Múltiple';
            btnOpcionMultiple.addEventListener('click', function () {
                if (tipoSeleccionado !== 'opcion_multiple') {
                    borrarRespuestas(questionDiv);
                    tipoSeleccionado = 'opcion_multiple';
                }
                const respuestas = questionDiv.querySelectorAll('.respuesta');
                if (respuestas.length < 4) {
                    agregarRespuesta(questionDiv, 'opcion_multiple');
                }
            });
    
            // Botón para borrar la última respuesta añadida
            const btnBorrarAnterior = document.createElement('button');
            btnBorrarAnterior.classList.add('btn', 'btn-secondary');
            btnBorrarAnterior.textContent = 'Borrar Última Respuesta';
            btnBorrarAnterior.addEventListener('click', function () {
                borrarUltimaRespuesta(questionDiv);
            });
    
            // Añadir los botones al grupo de botones
            buttonGroup.appendChild(btnParrafo);
            buttonGroup.appendChild(btnCheckbox);
            buttonGroup.appendChild(btnOpcionMultiple);
            buttonGroup.appendChild(btnBorrarAnterior);
    
            // Añadir los elementos al contenedor de la pregunta
            questionDiv.appendChild(questionLabel);
            questionDiv.appendChild(questionInput);
            questionDiv.appendChild(buttonGroup);
            formContainer.appendChild(questionDiv);
        });
    
        // Función para agregar la respuesta según el tipo seleccionado
        function agregarRespuesta(questionDiv, tipoRespuesta) {
            let respuestaDiv;
    
            if (tipoRespuesta === 'parrafo') {
                respuestaDiv = document.createElement('textarea');
                respuestaDiv.setAttribute('placeholder', 'Escribe tu respuesta aquí...');
                respuestaDiv.classList.add('form-control', 'respuesta', 'mb-2', 'parrafo');
            } else if (tipoRespuesta === 'checkbox') {
                respuestaDiv = document.createElement('div');
                respuestaDiv.classList.add('respuesta', 'mb-2');
    
                const checkbox = document.createElement('input');
                checkbox.setAttribute('type', 'checkbox');
                checkbox.classList.add('mr-2');
    
                const optionInput = document.createElement('input');
                optionInput.setAttribute('type', 'text');
                optionInput.setAttribute('placeholder', 'Escribe una opción');
                optionInput.classList.add('form-control', 'd-inline-block', 'w-50', 'respuesta-input');
    
                respuestaDiv.appendChild(checkbox);
                respuestaDiv.appendChild(optionInput);
            } else if (tipoRespuesta === 'opcion_multiple') {
                respuestaDiv = document.createElement('div');
                respuestaDiv.classList.add('respuesta', 'mb-2');
    
                const radio1 = document.createElement('input');
                radio1.setAttribute('type', 'radio');
                radio1.setAttribute('name', 'opcionMultiple');
                radio1.classList.add('mr-2');
    
                const optionInput1 = document.createElement('input');
                optionInput1.setAttribute('type', 'text');
                optionInput1.setAttribute('placeholder', 'Escribe una opción');
                optionInput1.classList.add('form-control', 'd-inline-block', 'w-50', 'respuesta-input');
    
                respuestaDiv.appendChild(radio1);
                respuestaDiv.appendChild(optionInput1);
                respuestaDiv.appendChild(document.createElement('br'));
            }
            questionDiv.appendChild(respuestaDiv);
        }
    
        // Función para borrar todas las respuestas de una pregunta
        function borrarRespuestas(questionDiv) {
            const respuestas = questionDiv.querySelectorAll('.respuesta');
            respuestas.forEach(respuesta => respuesta.remove());
        }
    
        // Función para borrar la última respuesta añadida
        function borrarUltimaRespuesta(questionDiv) {
            const respuestas = questionDiv.querySelectorAll('.respuesta');
            if (respuestas.length > 0) {
                const ultimaRespuesta = respuestas[respuestas.length - 1];
                ultimaRespuesta.remove();
            }
        }
    
        // Función para borrar la última pregunta añadida
        document.getElementById('borrar_pregunta').addEventListener('click', function () {
            const preguntas = document.querySelectorAll('#form-preguntas .form-group');
            if (preguntas.length > 0) {
                const ultimaPregunta = preguntas[preguntas.length - 1];
                ultimaPregunta.remove();
            }
        });
    
        // Función para validar el formulario antes de guardar
        document.querySelector('.btn_guardar_form').addEventListener('click', function (event) {
    console.log("Botón Guardar Formulario presionado");
    let error = false;
    const preguntas = document.querySelectorAll('.pregunta');

    // Validar el título
    const titulo = document.getElementById('txtcaja').value.trim();
    if (!titulo) {
        error = true;
        document.getElementById('txtcaja').classList.add('is-invalid');
    } else {
        document.getElementById('txtcaja').classList.remove('is-invalid');
    }

    // Validar que haya al menos una pregunta
    if (preguntas.length === 0) {
        error = true;
        alert('Debe agregar al menos una pregunta.');
    }

    const datosPreguntas = [];

    preguntas.forEach(function (preguntaDiv, index) {
        const pregunta = preguntaDiv.value.trim();
        if (!pregunta) {
            error = true;
            preguntaDiv.classList.add('is-invalid');
        } else {
            preguntaDiv.classList.remove('is-invalid');
        }

        // Validar que cada pregunta tenga al menos una respuesta
        const respuestas = preguntaDiv.parentElement.querySelectorAll('.respuesta');
        let respuestaValida = false;
        const respuestasArray = [];
        let respuestasCorrectas = [];

        respuestas.forEach(function (respuestaDiv) {
            // Validar respuesta tipo párrafo
            if (respuestaDiv.classList.contains('parrafo')) {
                respuestaValida = true; // No requiere respuesta adicional
            } else {
                const respuestaInput = respuestaDiv.querySelector('.respuesta-input');
                if (respuestaInput) {
                    if (respuestaInput.value.trim() !== '') {
                        respuestasArray.push(respuestaInput.value.trim());
                        // Verificar si es una respuesta correcta
                        if (respuestaDiv.querySelector('input[type="checkbox"]:checked')) {
                            respuestasCorrectas.push(respuestaInput.value.trim());
                        }
                        respuestaValida = true;
                    }
                }
            }
        });

        if (!respuestaValida) {
            error = true;
            alert('Cada pregunta debe tener al menos una respuesta válida (excepto para párrafos).');
        }

        datosPreguntas.push({
            pregunta: pregunta,
            tipo_respuesta: tipoSeleccionado,
            respuestas: respuestasArray,
            respuesta_correcta: respuestasCorrectas,
        });
    });

    // Evitar envío si hay errores
    if (error) {
        event.preventDefault();
        alert('Por favor, completa todos los campos obligatorios.');
    } else {
        // Enviar los datos al servidor
        const formData = new FormData();
        formData.append('nombre_formulario', titulo);
        formData.append('preguntas', JSON.stringify(datosPreguntas));

        fetch('backend/guardar_formulario.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            console.log("Datos recibidos:", data); // Verificar datos recibidos
            alert(data); // Mostrar el mensaje de éxito o error
            if (data.includes('éxito')) { // Cambia esta condición según tu mensaje de éxito
                limpiarFormulario(); // Limpiar el formulario si el envío fue exitoso
            }
        })
        .catch(error => {
            console.error('Error al guardar el formulario:', error);
            alert('Error al guardar el formulario. Por favor, intenta nuevamente.');
        });

        event.preventDefault(); // Prevenir el envío del formulario normal
    }
});  

    </script> 
</body>
</html>

